<!-- updated version 0.2 -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ATP Photo Placement Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .photo-slot {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s;
        min-height: 120px;
      }

      .photo-slot.highlight {
        border-color: #0d6efd;
        background-color: #f8f9fa;
      }

      .photo-slot.occupied {
        border-color: #198754;
        background-color: #d1e7dd;
      }

      .photo-preview {
        max-width: 150px;
        max-height: 100px;
        object-fit: contain;
        margin-right: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }

      .slot-info {
        font-size: 0.9em;
        color: #6c757d;
      }

      #dropZone {
        border: 3px dashed #007bff;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
      }

      #dropZone.dragover {
        background: #e3f2fd;
        border-color: #0d6efd;
      }

      /* NEW: Style for text fields */
      .text-field-group {
        margin-bottom: 15px;
        padding: 10px;
        border-left: 4px solid #6c757d;
        background-color: #f8f9fa;
        border-radius: 4px;
      }

      .required-field {
        border-left-color: #dc3545;
      }

      .field-info {
        font-size: 0.85em;
        color: #6c757d;
        margin-top: 5px;
      }

      .is-invalid {
        border-color: #dc3545 !important;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      .is-valid {
        border-color: #198754 !important;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
      }

      .valid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #198754;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-md-4">
          <!-- COVER SHEET CARD - Will be populated dynamically -->
          <div class="card mb-4" id="coverSheetCard">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0">Cover Sheet Information</h5>
            </div>
            <div class="card-body">
              <!-- This will be populated with dynamic fields -->
              <div id="coverSheetFields">
                <div class="text-center text-muted py-3">
                  <small
                    >Upload and analyze an ATP template to see required
                    information fields</small
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- UPLOAD TEMPLATE CARD -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">1. Upload ATP Template</h5>
            </div>
            <div class="card-body">
              <!-- In the HTML file, update the Project Code input field and add validation -->
              <div class="mb-3">
                <label class="form-label">Project Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="projectCode"
                  value=" "
                  oninput="validateProjectCode(this)"
                  placeholder="Enter project code (alphanumeric only)"
                />
                <div class="invalid-feedback" id="projectCodeFeedback">
                  Please use only letters, numbers, spaces, dashes, and
                  underscores.
                </div>
                <div class="valid-feedback" id="projectCodeValid">
                  ✓ Project code is valid
                </div>
              </div>

              <!-- Add a warning toast container at the top of the page -->
              <div
                id="warningToast"
                class="toast-container position-fixed top-0 end-0 p-3"
                style="z-index: 1050"
              >
                <div
                  class="toast align-items-center text-bg-warning border-0"
                  role="alert"
                  aria-live="assertive"
                  aria-atomic="true"
                >
                  <div class="d-flex">
                    <div class="toast-body">
                      <strong>Warning:</strong> <span id="toastMessage"></span>
                    </div>
                    <button
                      type="button"
                      class="btn-close btn-close-white me-2 m-auto"
                      data-bs-dismiss="toast"
                    ></button>
                  </div>
                </div>
              </div>

              <!-- upload section update -->

              <div class="mb-3">
                <label class="form-label"
                  >ATP Template File (.xlsx, .xls, or .docx)</label
                >
                <div id="dropZone" class="mb-3">
                  <p>Drag & drop your ATP template here</p>
                  <p class="text-muted">
                    Supports: Excel (.xlsx, .xls) and Word (.docx)
                  </p>
                  <p class="text-muted">or</p>
                  <button
                    class="btn btn-outline-primary"
                    onclick="document.getElementById('templateFile').click()"
                  >
                    Browse Files
                  </button>
                  <input
                    type="file"
                    id="templateFile"
                    accept=".xlsx,.xls,.docx"
                    class="d-none"
                  />
                </div>
                <div id="fileInfo" class="d-none">
                  <p>
                    <strong>Selected:</strong>
                    <span id="fileName"></span>
                    <span id="fileTypeBadge" class="badge ms-2"></span>
                  </p>
                  <button
                    class="btn btn-sm btn-success"
                    onclick="analyzeTemplate()"
                  >
                    Analyze Template
                  </button>
                </div>
              </div>
              <!-- upload section sampe sinii -->

              <div id="templateAnalysis" class="d-none">
                <h6>
                  Photo Slots Detected:
                  <span id="photoCount" class="badge bg-primary">0</span>
                </h6>
                <ul id="slotList" class="list-group"></ul>
              </div>
            </div>
          </div>

          <!-- PROCESS CARD -->
          <div class="card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">3. Process</h5>
            </div>
            <div class="card-body">
              <button
                id="processBtn"
                class="btn btn-success w-100"
                disabled
                onclick="processPhotos()"
              >
                Insert Photos into ATP Template
              </button>
              <div id="progress" class="mt-3 d-none">
                <div class="progress">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar"
                    style="width: 0%"
                  ></div>
                </div>
                <p class="text-center mt-2" id="progressText">Processing...</p>
              </div>
              <div id="result" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- PHOTO MAPPING COLUMN -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">2. Map Photos to Template</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info">
                Drag photos from your computer onto the appropriate slots below
              </div>

              <div id="photoSlotsContainer">
                <div class="text-center text-muted py-5">
                  Upload and analyze an ATP template first to see available
                  photo slots
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentTemplate = null;
      let photoMappings = {};
      let fileInput = null;
      // NEW: Store text field values
      let textFieldValues = {};

      document.addEventListener("DOMContentLoaded", function () {
        setupDropZones();
      });

      function setupDropZones() {
        const dropZone = document.getElementById("dropZone");

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener("drop", handleTemplateDrop, false);

        function highlight() {
          dropZone.classList.add("dragover");
        }

        function unhighlight() {
          dropZone.classList.remove("dragover");
        }
      }

      function handleTemplateDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0 && files[0].name.match(/\.(xlsx|xls|docx)$/i)) {
          document.getElementById("templateFile").files = files;
          handleTemplateSelect(files[0]);
        }
      }

      document
        .getElementById("templateFile")
        .addEventListener("change", function (e) {
          if (this.files.length > 0) {
            handleTemplateSelect(this.files[0]);
          }
        });

      // update handleExcelSelect part
      function handleTemplateSelect(file) {
        document.getElementById("fileName").textContent = file.name;

        // Show file type badge
        const fileTypeBadge = document.getElementById("fileTypeBadge");
        if (file.name.toLowerCase().endsWith(".docx")) {
          fileTypeBadge.className = "badge bg-info ms-2";
          fileTypeBadge.textContent = "Word Document";
        } else if (
          file.name.toLowerCase().endsWith(".xlsx") ||
          file.name.toLowerCase().endsWith(".xls")
        ) {
          fileTypeBadge.className = "badge bg-success ms-2";
          fileTypeBadge.textContent = "Excel Spreadsheet";
        } else {
          fileTypeBadge.className = "badge bg-secondary ms-2";
          fileTypeBadge.textContent = "Other";
        }

        document.getElementById("fileInfo").classList.remove("d-none");
        document.getElementById("templateAnalysis").classList.add("d-none");
        fileInput = file;
        resetProjectCode();

        // NEW: Reset the cover sheet when a new template is selected
        resetCoverSheet();
      }

      // NEW: Function to reset cover sheet to initial state
      function resetCoverSheet() {
        const card = document.getElementById("coverSheetCard");
        const fields = document.getElementById("coverSheetFields");

        card.classList.add("d-none");
        fields.innerHTML = "";
        textFieldValues = {};
      }

      async function analyzeTemplate() {
        if (!fileInput) return;

        const formData = new FormData();
        formData.append("excel_file", fileInput);

        try {
          const response = await fetch("/analyze_template", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            currentTemplate = result;

            // NEW: Display dynamic cover sheet fields based on template
            displayCoverSheetFields(result.text_fields || []);

            displayPhotoSlots(result.photo_slots);
            document.getElementById("processBtn").disabled = false;

            // Update photo count badge
            document.getElementById("photoCount").textContent =
              result.slots_count || 0;
          } else {
            alert("Error: " + result.error);
          }
        } catch (error) {
          alert("Error analyzing template: " + error.message);
        }
      }

      // NEW: Function to display dynamic cover sheet fields
      function displayCoverSheetFields(textFields) {
        const container = document.getElementById("coverSheetFields");
        const card = document.getElementById("coverSheetCard");

        if (!textFields || textFields.length === 0) {
          card.classList.add("d-none");
          textFieldValues = {};
          return;
        }

        card.classList.remove("d-none");

        let html = "";

        textFields.forEach((field) => {
          // Create a clean field ID
          const fieldId = `text_${field.placeholder_key}`;

          // Determine if required
          const isRequired =
            field.required ||
            ["site_id", "site_name", "project_code", "date"].includes(
              field.placeholder_key,
            );

          // Special handling for date - pre-fill with today's date
          let defaultValue = "";
          if (field.placeholder_key === "date") {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, "0");
            const mm = String(today.getMonth() + 1).padStart(2, "0");
            const yyyy = today.getFullYear();
            defaultValue = `${dd}/${mm}/${yyyy}`;
          }

          html += `
            <div class="text-field-group ${isRequired ? "required-field" : ""}" id="field-group-${fieldId}">
                <label class="form-label">
                    ${field.display_name || field.placeholder}
                    ${isRequired ? '<span class="text-danger">*</span>' : ""}
                </label>
                <input
                    type="text"
                    class="form-control form-control-sm"
                    id="${fieldId}"
                    ${isRequired ? "required" : ""}
                    value="${defaultValue}"
                    placeholder="Enter ${field.display_name || field.placeholder}"
                    oninput="updateTextFieldValue('${fieldId}', this.value)"
                />
                <small class="text-muted">${field.location || ""}</small>
            </div>
        `;

          // Store initial value
          textFieldValues[fieldId] = defaultValue;
        });

        container.innerHTML = html;

        // Trigger validation after fields are added
        validateForm();
      }

      // NEW: Default cover sheet fields if no placeholders are detected
      function getDefaultCoverSheetFields() {
        const defaultFields = [
          { id: "site_id", label: "Site ID", required: true },
          { id: "site_name", label: "Site Name", required: true },
          { id: "hostname", label: "Hostname", required: false },
          { id: "scope_of_work", label: "Scope of Work", required: false },
          { id: "device_type", label: "Device Type", required: false },
        ];

        let html = "";

        defaultFields.forEach((field) => {
          html += `
                    <div class="text-field-group ${field.required ? "required-field" : ""}">
                        <label class="form-label">
                            ${field.label}
                            ${field.required ? '<span class="text-danger">*</span>' : ""}
                        </label>
                        <input type="text" 
                               class="form-control form-control-sm" 
                               id="${field.id}"
                               placeholder="Enter ${field.label}"
                               oninput="updateTextFieldValue('${field.id}', this.value)"
                               ${field.required ? "required" : ""}>
                    </div>
                `;

          textFieldValues[field.id] = "";
        });

        return html;
      }

      // NEW: Function to update text field values
      function updateTextFieldValue(fieldId, value) {
        textFieldValues[fieldId] = value;
        validateForm();
      }

      // NEW: Function to validate the form before submission
      // function validateForm() {
      //   // Check if all required fields are filled
      //   const requiredFields = document.querySelectorAll(
      //     ".required-field input[required]",
      //   );
      //   let allValid = true;
      //
      //   requiredFields.forEach((field) => {
      //     if (!field.value.trim()) {
      //       allValid = false;
      //       document
      //         .getElementById(`field-group-${field.id}`)
      //         .classList.add("border-danger");
      //     } else {
      //       document
      //         .getElementById(`field-group-${field.id}`)
      //         .classList.remove("border-danger");
      //     }
      //   });
      //
      //   return allValid;
      // }

      function validateForm() {
        const requiredFields = document.querySelectorAll(
          ".required-field input[required]",
        );

        let allValid = true;

        requiredFields.forEach((field) => {
          const wrapper = document.getElementById(`field-group-${field.id}`);

          if (!field.value.trim()) {
            allValid = false;

            if (wrapper) {
              wrapper.classList.add("border-danger");
            }
          } else {
            if (wrapper) {
              wrapper.classList.remove("border-danger");
            }
          }
        });

        return allValid;
      }

      function displayPhotoSlots(slots) {
        const container = document.getElementById("photoSlotsContainer");
        const slotList = document.getElementById("slotList");

        container.innerHTML = "";
        slotList.innerHTML = "";

        slots.forEach((slot, index) => {
          // Determine what information to show based on available data
          const slotType = slot.type || slot.photo_type;
          const slotLocation =
            slot.location ||
            (slot.sheet ? `${slot.sheet} • Cell ${slot.target_cell}` : "");

          const listItem = document.createElement("li");
          listItem.className =
            "list-group-item d-flex justify-content-between align-items-center";
          listItem.innerHTML = `
            ${slotType}
            <span class="badge bg-secondary">${slotLocation || ""}</span>
        `;
          slotList.appendChild(listItem);

          const slotCard = document.createElement("div");
          slotCard.className = "photo-slot";
          slotCard.id = `slot-${index}`;
          slotCard.dataset.slotIndex = index;
          slotCard.dataset.photoType = slotType;

          slotCard.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6 class="mb-1">${slotType}</h6>
                    <p class="slot-info mb-1">${slot.description || ""}</p>
                    <small class="text-muted">${slotLocation}</small>
                </div>
                <span class="badge bg-secondary">Slot ${index + 1}</span>
            </div>
            <div class="slot-content" id="slot-content-${index}">
                <div class="text-center text-muted py-3">
                    <small>Drag & drop a photo here or click to select</small>
                </div>
            </div>
            <input type="file" class="d-none slot-file-input" 
                   data-slot-index="${index}" accept="image/*">
        `;

          container.appendChild(slotCard);
          makeSlotDroppable(slotCard, index);
        });

        document.getElementById("templateAnalysis").classList.remove("d-none");
      }

      function makeSlotDroppable(slotElement, slotIndex) {
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          slotElement.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          slotElement.addEventListener(
            eventName,
            function () {
              slotElement.classList.add("highlight");
            },
            false,
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          slotElement.addEventListener(
            eventName,
            function () {
              slotElement.classList.remove("highlight");
            },
            false,
          );
        });

        slotElement.addEventListener(
          "drop",
          function (e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0 && files[0].type.match("image.*")) {
              assignPhotoToSlot(files[0], slotIndex);
            }
          },
          false,
        );

        slotElement.addEventListener("click", function (e) {
          if (e.target.type !== "file") {
            const fileInput = slotElement.querySelector(".slot-file-input");
            fileInput.click();
          }
        });

        const fileInput = slotElement.querySelector(".slot-file-input");
        fileInput.addEventListener("change", function (e) {
          if (this.files.length > 0) {
            assignPhotoToSlot(this.files[0], slotIndex);
          }
        });
      }

      function assignPhotoToSlot(file, slotIndex) {
        const slot = currentTemplate.photo_slots[slotIndex];
        const slotContent = document.getElementById(
          `slot-content-${slotIndex}`,
        );
        const slotElement = document.getElementById(`slot-${slotIndex}`);

        const reader = new FileReader();
        reader.onload = function (e) {
          slotContent.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${e.target.result}" class="photo-preview" alt="Preview">
                        <div>
                            <p class="mb-1"><strong>${file.name}</strong></p>
                            <p class="mb-1 small">${(file.size / 1024).toFixed(1)} KB</p>
                            <button class="btn btn-sm btn-outline-danger" onclick="removePhoto(${slotIndex})">
                                Remove
                            </button>
                        </div>
                    </div>
                `;

          slotElement.classList.add("occupied");
          slotElement.classList.remove("highlight");

          photoMappings[slotIndex] = {
            slot_index: slotIndex,
            photo_type: slot.type,
            file_name: file.name,
            field_name: `photo_${slotIndex}`,
            file: file,
          };
        };
        reader.readAsDataURL(file);
      }

      function removePhoto(slotIndex) {
        const slotContent = document.getElementById(
          `slot-content-${slotIndex}`,
        );
        const slotElement = document.getElementById(`slot-${slotIndex}`);

        slotContent.innerHTML = `
                <div class="text-center text-muted py-3">
                    <small>Drag & drop a photo here or click to select</small>
                </div>
            `;

        slotElement.classList.remove("occupied");
        delete photoMappings[slotIndex];
      }

      // NEW: Function to validate project code in real-time
      function validateProjectCode(input) {
        const projectCode = input.value;
        const feedback = document.getElementById("projectCodeFeedback");
        const validFeedback = document.getElementById("projectCodeValid");

        // Check for invalid characters
        const invalidChars = /[<>:"/\\|?*#!@$%^&()=+]/;

        if (invalidChars.test(projectCode)) {
          input.classList.add("is-invalid");
          input.classList.remove("is-valid");
          feedback.style.display = "block";
          validFeedback.style.display = "none";

          // Show warning toast
          showWarningToast(
            "Project code contains invalid characters (like ?, !, #, etc.). They will be automatically removed.",
          );
          return false;
        } else {
          input.classList.remove("is-invalid");
          input.classList.add("is-valid");
          feedback.style.display = "none";
          validFeedback.style.display = "block";
          return true;
        }
      }

      // NEW: Function to show warning toast
      function showWarningToast(message) {
        const toastElement = document.querySelector("#warningToast .toast");
        const toastMessage = document.getElementById("toastMessage");

        toastMessage.textContent = message;

        // Initialize Bootstrap toast if not already done
        if (!toastElement.classList.contains("show")) {
          const toast = new bootstrap.Toast(toastElement);
          toast.show();
        }
      }

      // NEW: Function to sanitize project code on the client side
      function sanitizeProjectCode(code) {
        // Remove invalid characters
        return code
          .replace(/[<>:"/\\|?*#!@$%^&()=+]/g, "")
          .replace(/\s+/g, " ")
          .trim(" .-_");
      }

      async function processPhotos() {
        // Validate project code first
        const projectCodeInput = document.getElementById("projectCode");
        const rawProjectCode = projectCodeInput.value.trim();

        // Sanitize project code on client side
        const sanitizedProjectCode = sanitizeProjectCode(rawProjectCode);

        // If sanitization happened, update the input field and show warning
        if (rawProjectCode !== sanitizedProjectCode) {
          projectCodeInput.value = sanitizedProjectCode;
          showWarningToast(
            `Project code was sanitized from "${rawProjectCode}" to "${sanitizedProjectCode}"`,
          );

          // Re-validate
          validateProjectCode(projectCodeInput);
        }

        // Validate form before proceeding
        if (!validateForm()) {
          showWarningToast("Please fill in all required fields marked with *");
          return;
        }

        if (Object.keys(photoMappings).length === 0) {
          showWarningToast("Please assign at least one photo to a slot");
          return;
        }

        const formData = new FormData();

        // Add dynamic text field values
        Object.keys(textFieldValues).forEach((key) => {
          const backendKey = key.startsWith("text_")
            ? key.replace("text_", "")
            : key;
          formData.append(backendKey, textFieldValues[key]);
        });

        formData.append("excel_file", fileInput);
        formData.append("project_code", sanitizedProjectCode); // Use sanitized version

        // Create mappings based on template type
        const mappings = Object.values(photoMappings).map((mapping) => {
          const slotIndex = mapping.slot_index;
          const slot = currentTemplate.photo_slots[slotIndex];

          // Create base mapping
          const baseMapping = {
            field_name: mapping.field_name,
            slot_index: slotIndex,
            photo_type: mapping.photo_type,
          };

          // Add Excel-specific fields if available
          if (slot.sheet && slot.target_cell) {
            baseMapping.sheet = slot.sheet;
            baseMapping.target_cell = slot.target_cell;
          }

          // Add DOCX-specific fields if available
          if (slot.location) {
            baseMapping.location = slot.location;
          }

          return baseMapping;
        });

        formData.append("photo_mappings", JSON.stringify(mappings));

        Object.values(photoMappings).forEach((mapping) => {
          formData.append(mapping.field_name, mapping.file);
        });

        document.getElementById("progress").classList.remove("d-none");
        document.getElementById("processBtn").disabled = true;
        document.getElementById("result").innerHTML = ""; // Clear previous results

        try {
          const response = await fetch("/upload_photos", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            let message = result.message;

            // If there's a sanitization warning from backend, show it
            if (result.sanitization_warning) {
              message += `<br><small class="text-warning">${result.sanitization_warning}</small>`;
            }

            document.getElementById("result").innerHTML = `
                    <div class="alert alert-success">
                        <h5>✓ Success!</h5>
                        <p>${message}</p>
                        <a href="${result.download_url}" class="btn btn-success">
                            Download Updated ATP Document
                        </a>
                    </div>
                `;
          } else {
            document.getElementById("result").innerHTML = `
                    <div class="alert alert-danger">
                        <h5>✗ Error</h5>
                        <p>${result.error}</p>
                    </div>
                `;
          }
        } catch (error) {
          document.getElementById("result").innerHTML = `
                <div class="alert alert-danger">
                    <h5>✗ Processing Failed</h5>
                    <p>${error.message}</p>
                </div>
            `;
        } finally {
          document.getElementById("progress").classList.add("d-none");
          document.getElementById("processBtn").disabled = false;
        }
      }

      function resetProjectCode() {
        const projectCodeInput = document.getElementById("projectCode");
        const currentValue = projectCodeInput.value;

        // Check if current value has invalid characters
        const invalidChars = /[<>:"/\\|?*#!@$%^&()=+]/;

        if (invalidChars.test(currentValue)) {
          // If it has invalid chars, clear it
          projectCodeInput.value = "";
        }
      }
      document.addEventListener("DOMContentLoaded", function () {
        setupDropZones();
        // Add this line if you don't have it:
        resetProjectCode(); // Clear any invalid project code on page load
      });
    </script>
  </body>
</html>
